<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
		<script type="text/javascript" src="js/three.js"></script>
		<script type="text/javascript" src="js/Detector.js"></script>
		<script type="text/javascript" src="js/d3.js"></script>
		<script>
			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 1000 );
			camera.position.set(175,175,175);
			camera.lookAt(new THREE.Vector3(0,0,0));
			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );
					
			var particles = new THREE.Geometry();
			var pMaterial = new THREE.PointsMaterial({
				vertexColors: THREE.VertexColors,
				size: 2,
				map: new THREE.TextureLoader().load("images/particle.png"),
				blending: THREE.AdditiveBlending,
				transparent: true
				 });
			var particleSystem = new THREE.Points(particles,pMaterial);
				 			
			// read in the datafile
			var df = [];
			d3.csv("data/POM.csv", function(data) { 				
				df = data;
				genCloud(df);
				});
			// particles
			
			function genCloud(df) {
				var particleCount = df.length;
				for (var p=0;p<df.length;p++) {
					pRed = parseInt(df[p].color.substr(0,2),16);
					pGreen = parseInt(df[p].color.substr(2,2),16);
					pBlue = parseInt(df[p].color.substr(4,2),16);
					var particle = new THREE.Vector3(pRed, pGreen, pBlue);
					particles.vertices.push(particle);
					particles.colors.push(new THREE.Color("#"+df[p].color));
				}
				particleSystem.sortParticles = true;
				THREE.GeometryUtils.center(particles);
				scene.add(particleSystem);
				animate();
			}
			
			function animate() {
				particleSystem.rotation.x += 0.01;
				particleSystem.rotation.y += 0.01;
				renderer.render(scene, camera);
				requestAnimationFrame(animate);				
			}
			
			if (Detector.webgl) {
				animate();
			} else {
				var warning = Detector.getWebGLErrorMessage();
				document.getElementById('container').appendChild(warning);
			}
		</script>
	</body>
</html>
